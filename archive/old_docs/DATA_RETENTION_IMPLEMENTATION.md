# æ•°æ®ç•™å­˜æœºåˆ¶å®ç°æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†å®Œæ•´çš„æ•°æ®ç•™å­˜æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š
- âœ… æ£€æµ‹ç»“æœæ•°æ®åº“ç•™å­˜ï¼ˆSQLiteï¼‰
- âœ… è½¦è¾†å¿«ç…§å›¾åƒç•™å­˜
- âœ… ç›‘æ§æˆªå›¾ç•™å­˜
- âœ… è‡ªåŠ¨ç©ºé—´æ§åˆ¶ï¼ˆå¾ªç¯å†™å…¥ï¼‰
- âœ… è‡ªåŠ¨æ¸…ç†æœºåˆ¶

---

## ğŸ—‚ï¸ æ•°æ®å­˜å‚¨ä½ç½®

### 1. æ£€æµ‹ç»“æœæ•°æ®åº“

- **è·¯å¾„**: `detection_results.db` (é¡¹ç›®æ ¹ç›®å½•)
- **ç±»å‹**: SQLiteæ•°æ®åº“
- **å½“å‰å¤§å°**: 2.7MB
- **å†…å®¹**: æ‰€æœ‰æ£€æµ‹è®°å½•ï¼ˆæ—¶é—´æˆ³ã€ç±»åˆ«ã€ç½®ä¿¡åº¦ã€ä½ç½®ã€ä¿¡æ ‡ä¿¡æ¯ç­‰ï¼‰

### 2. è½¦è¾†å¿«ç…§

- **è·¯å¾„**: `/tmp/vehicle_snapshots/snapshot_*.jpg`
- **ç±»å‹**: JPEGå›¾åƒ
- **å½“å‰å¤§å°**: 42MB
- **å†…å®¹**: æ£€æµ‹åˆ°çš„è½¦è¾†è£å‰ªå›¾åƒ

### 3. ç›‘æ§æˆªå›¾

- **è·¯å¾„**: `/tmp/vehicle_snapshots/monitoring_snapshot_*.jpg`
- **ç±»å‹**: JPEGå›¾åƒ
- **å†…å®¹**: å®šæ—¶ä¸Šä¼ çš„ç°åœºé«˜æ¸…æˆªå›¾

---

## âš™ï¸ é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ï¼š`config.yaml`

```yaml
data_retention:
  # æ•°æ®åº“ç•™å­˜ç­–ç•¥
  database:
    enabled: true                  # æ˜¯å¦å¯ç”¨æ•°æ®åº“ç•™å­˜
    max_records: 10000             # æœ€å¤§è®°å½•æ•°ï¼ˆå¾ªç¯å†™å…¥ï¼‰
    retention_days: 30             # ä¿ç•™å¤©æ•°
    auto_cleanup: true             # æ˜¯å¦è‡ªåŠ¨æ¸…ç†
    cleanup_interval_hours: 24     # è‡ªåŠ¨æ¸…ç†é—´éš”ï¼ˆå°æ—¶ï¼‰
  
  # å¿«ç…§ç•™å­˜ç­–ç•¥
  snapshots:
    enabled: true                  # æ˜¯å¦å¯ç”¨å¿«ç…§ç•™å­˜
    max_count: 1000                # æœ€å¤§å¿«ç…§æ•°é‡ï¼ˆå¾ªç¯å†™å…¥ï¼‰
    max_size_mb: 500               # æœ€å¤§æ€»å¤§å°ï¼ˆMBï¼‰
    retention_days: 7              # ä¿ç•™å¤©æ•°
    auto_cleanup: true             # æ˜¯å¦è‡ªåŠ¨æ¸…ç†
    cleanup_interval_hours: 6      # è‡ªåŠ¨æ¸…ç†é—´éš”ï¼ˆå°æ—¶ï¼‰
  
  # ç›‘æ§æˆªå›¾ç•™å­˜ç­–ç•¥
  monitoring_snapshots:
    enabled: true                  # æ˜¯å¦å¯ç”¨ç›‘æ§æˆªå›¾ç•™å­˜
    max_count: 500                 # æœ€å¤§ç›‘æ§æˆªå›¾æ•°é‡
    max_size_mb: 200               # æœ€å¤§æ€»å¤§å°ï¼ˆMBï¼‰
    retention_days: 3              # ä¿ç•™å¤©æ•°
    auto_cleanup: true             # æ˜¯å¦è‡ªåŠ¨æ¸…ç†
    cleanup_interval_hours: 12     # è‡ªåŠ¨æ¸…ç†é—´éš”ï¼ˆå°æ—¶ï¼‰
```

---

## ğŸ”„ å¾ªç¯å†™å…¥æœºåˆ¶

### æ•°æ®åº“å¾ªç¯å†™å…¥

- **æœºåˆ¶**: å½“è®°å½•æ•°è¶…è¿‡ `max_records` æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æœ€æ—§çš„è®°å½•
- **å®ç°**: `DetectionDatabase.cleanup_excess_records()`
- **ç‰¹ç‚¹**: 
  - ä¿æŒæ•°æ®åº“å¤§å°åœ¨é™åˆ¶èŒƒå›´å†…
  - å§‹ç»ˆä¿ç•™æœ€æ–°çš„ `max_records` æ¡è®°å½•
  - è‡ªåŠ¨æ‰§è¡ŒVACUUMå›æ”¶ç©ºé—´

### å¿«ç…§å¾ªç¯å†™å…¥

- **æœºåˆ¶**: å½“å¿«ç…§æ•°é‡è¶…è¿‡ `max_count` æˆ–æ€»å¤§å°è¶…è¿‡ `max_size_mb` æ—¶ï¼Œåˆ é™¤æœ€æ—§çš„å¿«ç…§
- **å®ç°**: `DataRetentionManager.cleanup_snapshots()`
- **ç‰¹ç‚¹**:
  - æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼Œåˆ é™¤æœ€æ—§çš„æ–‡ä»¶
  - åŒæ—¶è€ƒè™‘æ•°é‡é™åˆ¶å’Œå¤§å°é™åˆ¶
  - ä¿ç•™æœ€æ–°çš„å¿«ç…§

---

## ğŸ§¹ è‡ªåŠ¨æ¸…ç†æœºåˆ¶

### æ¸…ç†ç­–ç•¥

1. **æŒ‰æ—¶é—´æ¸…ç†**:
   - åˆ é™¤è¶…è¿‡ `retention_days` å¤©çš„æ•°æ®
   - é€‚ç”¨äºæ•°æ®åº“è®°å½•å’Œå¿«ç…§æ–‡ä»¶

2. **æŒ‰æ•°é‡æ¸…ç†**:
   - åˆ é™¤è¶…å‡º `max_count` çš„æœ€æ—§æ•°æ®
   - å®ç°å¾ªç¯å†™å…¥

3. **æŒ‰å¤§å°æ¸…ç†**:
   - åˆ é™¤è¶…å‡º `max_size_mb` çš„æœ€æ—§æ•°æ®
   - é€‚ç”¨äºå¿«ç…§ç›®å½•

### æ¸…ç†æ—¶æœº

- **å¯åŠ¨æ—¶**: ç³»ç»Ÿå¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†
- **å®šæ—¶æ¸…ç†**: æŒ‰é…ç½®çš„é—´éš”è‡ªåŠ¨æ‰§è¡Œæ¸…ç†
  - æ•°æ®åº“: é»˜è®¤æ¯24å°æ—¶
  - å¿«ç…§: é»˜è®¤æ¯6å°æ—¶
  - ç›‘æ§æˆªå›¾: é»˜è®¤æ¯12å°æ—¶

---

## ğŸ“Š æ•°æ®ç•™å­˜ç»Ÿè®¡

### æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```python
from python_apps.data_retention_manager import DataRetentionManager
from python_apps.detection_database import DetectionDatabase

# åˆå§‹åŒ–
db = DetectionDatabase("detection_results.db")
retention_manager = DataRetentionManager(config, detection_db=db)

# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = retention_manager.get_statistics()
print(stats)
```

### ä½¿ç”¨æ£€æŸ¥è„šæœ¬

```bash
bash scripts/check_data_retention.sh
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
=== æ•°æ®ç•™å­˜çŠ¶æ€æ£€æŸ¥ ===

ğŸ“Š æ£€æµ‹ç»“æœæ•°æ®åº“:
  æ–‡ä»¶å¤§å°: 2.7M
  è®°å½•æ•°: 1234
  æœ€è¿‘è®°å½•: 56 æ¡ï¼ˆ24å°æ—¶å†…ï¼‰

ğŸ“¸ è½¦è¾†å¿«ç…§:
  æ•°é‡: 234 å¼ 
  æ€»å¤§å°: 42M
  æœ€è¿‘24å°æ—¶: 12 å¼ 

ğŸ“· ç›‘æ§æˆªå›¾:
  æ•°é‡: 45 å¼ 
  æ€»å¤§å°: 8.5M
  æœ€è¿‘24å°æ—¶: 6 å¼ 
```

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. DetectionDatabase å¢å¼º

æ–°å¢æ–¹æ³•ï¼š
- `cleanup_excess_records(max_records)`: æ¸…ç†è¶…å‡ºæœ€å¤§è®°å½•æ•°çš„æ—§è®°å½•
- `get_record_count()`: è·å–å½“å‰è®°å½•æ•°
- `get_database_size_mb()`: è·å–æ•°æ®åº“æ–‡ä»¶å¤§å°

### 2. DataRetentionManager ç±»

åŠŸèƒ½ï¼š
- è‡ªåŠ¨æ¸…ç†çº¿ç¨‹ç®¡ç†
- æ•°æ®åº“æ¸…ç†
- å¿«ç…§æ¸…ç†
- ç›‘æ§æˆªå›¾æ¸…ç†
- ç»Ÿè®¡ä¿¡æ¯è·å–

### 3. é›†æˆåˆ°ä¸»ç¨‹åº

- åœ¨ `RealtimeVehicleDetection.__init__` ä¸­åˆå§‹åŒ–
- åœ¨ `run()` æ–¹æ³•ä¸­å¯åŠ¨è‡ªåŠ¨æ¸…ç†çº¿ç¨‹
- å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### æ‰‹åŠ¨æ¸…ç†

```python
from python_apps.data_retention_manager import DataRetentionManager
from python_apps.detection_database import DetectionDatabase

# åˆå§‹åŒ–
db = DetectionDatabase("detection_results.db")
retention_manager = DataRetentionManager(config, detection_db=db)
retention_manager.set_snapshot_dir("/tmp/vehicle_snapshots")

# æ‰‹åŠ¨æ¸…ç†æ•°æ®åº“
deleted = retention_manager.cleanup_database()
print(f"åˆ é™¤äº† {deleted} æ¡æ•°æ®åº“è®°å½•")

# æ‰‹åŠ¨æ¸…ç†å¿«ç…§
deleted = retention_manager.cleanup_snapshots()
print(f"åˆ é™¤äº† {deleted} å¼ å¿«ç…§")

# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = retention_manager.get_statistics()
print(f"æ•°æ®åº“: {stats['database']['record_count']} æ¡è®°å½•")
print(f"å¿«ç…§: {stats['snapshots']['count']} å¼ ")
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **/tmpç›®å½•æ¸…ç†**:
   - `/tmp` ç›®å½•å¯èƒ½åœ¨ç³»ç»Ÿé‡å¯åæ¸…ç©º
   - å»ºè®®å°†å¿«ç…§ç›®å½•é…ç½®åˆ°é¡¹ç›®ç›®å½•ï¼ˆå¦‚ `data/snapshots`ï¼‰

2. **ç£ç›˜ç©ºé—´ç›‘æ§**:
   - å®šæœŸæ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
   - å¦‚æœç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ¸…ç†æœºåˆ¶ä¼šè‡ªåŠ¨åˆ é™¤æœ€æ—§çš„æ•°æ®

3. **æ•°æ®å¤‡ä»½**:
   - é‡è¦æ•°æ®å»ºè®®å®šæœŸå¤‡ä»½
   - æ•°æ®åº“æ–‡ä»¶å¯ä»¥å®šæœŸå¯¼å‡º

4. **æ€§èƒ½å½±å“**:
   - è‡ªåŠ¨æ¸…ç†åœ¨åå°çº¿ç¨‹æ‰§è¡Œï¼Œä¸å½±å“ä¸»ç¨‹åºæ€§èƒ½
   - æ¸…ç†æ“ä½œä½¿ç”¨é”æœºåˆ¶ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **ç¡®è®¤é…ç½®**:
   ```bash
   # æ£€æŸ¥config.yamlä¸­çš„data_retentioné…ç½®
   grep -A 20 "data_retention:" config.yaml
   ```

2. **é‡å¯æœåŠ¡**:
   ```bash
   sudo systemctl restart vehicle-detection
   ```

3. **éªŒè¯åŠŸèƒ½**:
   ```bash
   # æ£€æŸ¥æ•°æ®ç•™å­˜çŠ¶æ€
   bash scripts/check_data_retention.sh
   
   # æŸ¥çœ‹æ—¥å¿—
   tail -f /tmp/vehicle_detection.log | grep "cleanup"
   ```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ç©ºé—´æ§åˆ¶

- **æ•°æ®åº“**: æœ€å¤§10,000æ¡è®°å½•ï¼ˆçº¦10MBï¼‰
- **å¿«ç…§**: æœ€å¤§1,000å¼ æˆ–500MB
- **ç›‘æ§æˆªå›¾**: æœ€å¤§500å¼ æˆ–200MB
- **æ€»è®¡**: çº¦710MBï¼ˆå¯é…ç½®ï¼‰

### æ•°æ®ä¿ç•™

- **æ•°æ®åº“**: ä¿ç•™30å¤©å†…çš„è®°å½•
- **å¿«ç…§**: ä¿ç•™7å¤©å†…çš„å¿«ç…§
- **ç›‘æ§æˆªå›¾**: ä¿ç•™3å¤©å†…çš„æˆªå›¾

### è‡ªåŠ¨ç®¡ç†

- âœ… è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®
- âœ… è‡ªåŠ¨æ§åˆ¶ç©ºé—´å ç”¨
- âœ… å¾ªç¯å†™å…¥ï¼Œä¿æŒæœ€æ–°æ•°æ®
- âœ… åå°è¿è¡Œï¼Œä¸å½±å“ä¸»ç¨‹åº

---

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**ï¼šâ³ å¾…éªŒè¯  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

