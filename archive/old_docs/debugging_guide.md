# 系统调试指南

## 已添加的改进

### 1. BLE信标匹配增强 ✅

**距离对比逻辑：**
```python
# 1. 获取相机深度
distance = depth_camera.get_depth_at_point(cx, cy)  # 米

# 2. 获取所有BLE信标
beacons = beacon_client.get_beacons()
# 每个信标包含: {'mac': ..., 'rssi': ..., 'distance': ...}

# 3. 距离匹配
# 找到距离差<2米的信标
matched_beacons = [b for b in beacons if abs(b['distance'] - distance) < 2.0]

# 4. 选择距离最接近的
beacon_info = min(matched_beacons, key=lambda b: abs(b['distance'] - distance))
```

**备用方案：**
- 如果没有深度信息 → 使用信号最强的信标
- 如果没有匹配的信标 → 报告"未备案"

### 2. 详细调试输出 ✅

**工程车辆检查输出：**
```
======================================================================
🔍 检查工程车辆 Track#1
  📏 相机深度: 2.45 m
  📡 扫描到信标数量: 2
     信标1: MAC=AA:BB:CC:DD, RSSI=-65, 距离≈2.3m
     信标2: MAC=EE:FF:00:11, RSSI=-75, 距离≈5.1m
  ✓ 匹配到信标: MAC=AA:BB:CC:DD, 距离差=0.15m
  ✅ 结果: 已备案工程车辆
======================================================================
```

**社会车辆检查输出：**
```
======================================================================
🚗 检查社会车辆 Track#2
  📐 车辆ROI尺寸: (120, 240, 3)
  🔍 识别结果数量: 1
  ✓ 车牌号: 粤B12345 (置信度: 0.89)
  ✅ 结果: 社会车辆 粤B12345
======================================================================
```

---

## 调试步骤

### 步骤1：检查BLE信标扫描

**问题：为什么总是显示"未备案"？**

运行系统，观察终端输出：

```bash
cd /home/liubo/Download/deepstream-vehicle-detection
bash 测试自定义模型.sh
```

**检查点：**

1. **Cassia客户端是否启动？**
   ```
   【3. 连接Cassia蓝牙路由器】
   ✓ Cassia本地扫描已启动
   ✓ Cassia客户端启动成功: 192.168.40.1
   ```
   
   如果看到：
   ```
   ⚠ Cassia客户端启动失败: ...
   ```
   → 检查网络连接：`ping 192.168.40.1`

2. **是否扫描到信标？**
   ```
   🔍 检查工程车辆 Track#1
     📡 扫描到信标数量: 0  ← 如果是0，说明没扫描到
   ```
   
   **可能原因：**
   - BLE标签未开启（检查LED是否闪烁）
   - 标签电量耗尽
   - 距离太远（>10米）
   - Cassia路由器未正常工作

3. **距离匹配是否成功？**
   ```
   📏 相机深度: 2.45 m
   📡 扫描到信标数量: 1
      信标1: MAC=AA:BB:CC:DD, RSSI=-65, 距离≈5.5m  ← 距离差3m
   ✗ 无匹配信标（距离差都>2m）  ← 距离差太大
   ```
   
   **解决方案：**
   - 调整iPad和BLE标签的位置，使它们在相同距离
   - 或者增大距离容差（见下文）

---

### 步骤2：检查车牌识别

**问题：为什么没有车牌输出？**

**检查点：**

1. **识别器是否初始化？**
   ```
   【5. 初始化车牌识别】
   ✓ HyperLPR初始化成功 (CPU推理)
   ```

2. **ROI尺寸是否合适？**
   ```
   🚗 检查社会车辆 Track#2
     📐 车辆ROI尺寸: (30, 50, 3)  ← 太小！
     ✗ ROI太小，跳过识别
   ```
   
   **解决方案：**
   - iPad离相机太远 → 靠近一些
   - 图片中车辆太小 → 使用更大的图片

3. **是否识别到车牌？**
   ```
   🔍 识别结果数量: 0  ← 未识别到
   ✗ 未识别到车牌
   ```
   
   **可能原因：**
   - 图片中没有清晰的车牌
   - 车牌角度太倾斜
   - 图片分辨率太低
   - 光线反射严重

---

## 参数调整

### 调整1：距离匹配容差

如果距离匹配总是失败，可以增大容差：

编辑 `test_system_realtime.py`，找到：

```python
# 距离匹配：找到距离差<2米的信标
matched_beacons = [b for b in beacons if abs(b['distance'] - distance) < 2.0]
```

改为：
```python
# 距离匹配：找到距离差<3米的信标（增大容差）
matched_beacons = [b for b in beacons if abs(b['distance'] - distance) < 3.0]
```

### 调整2：禁用距离匹配（临时测试）

如果只想测试BLE功能，不考虑距离：

```python
# 临时：使用信号最强的信标（不管距离）
if beacons:
    beacon_info = max(beacons, key=lambda b: b['rssi'])
```

### 调整3：车牌识别参数

如果车牌总是识别失败，尝试：

```python
# 使用高精度模式
self.lpr_detector = lpr3.LicensePlateCatcher(
    inference=lpr3.INFER_ONNX_RUNTIME,
    detect_level=lpr3.DETECT_LEVEL_HIGH  # 改为HIGH
)
```

---

## 测试建议

### 测试BLE匹配

**最佳测试条件：**

1. **准备：**
   - 确保BLE标签开启（LED闪烁）
   - iPad显示工程机械图片（全屏）
   - 将BLE标签贴在iPad旁边

2. **距离：**
   - iPad距离相机：1.5-2.5米
   - BLE标签与iPad的距离：<10cm（尽量近）

3. **观察输出：**
   ```
   📏 相机深度: 2.1 m
   📡 扫描到信标数量: 1
      信标1: MAC=AA:BB:CC:DD, RSSI=-60, 距离≈2.0m
   ✓ 匹配到信标: MAC=AA:BB:CC:DD, 距离差=0.1m
   ✅ 结果: 已备案工程车辆  ← 成功！
   ```

### 测试车牌识别

**最佳测试条件：**

1. **图片要求：**
   - 清晰的车牌特写
   - 车牌占图片比例：>5%
   - 车牌角度：正面或±30度内

2. **显示：**
   - iPad全屏显示
   - 避免屏幕反光
   - 距离相机：1-2米

3. **观察输出：**
   ```
   📐 车辆ROI尺寸: (180, 320, 3)  ← 足够大
   🔍 识别结果数量: 1
   ✓ 车牌号: 粤B12345 (置信度: 0.92)  ← 成功！
   ```

---

## 快速诊断

### BLE问题诊断

| 输出 | 问题 | 解决方案 |
|------|------|---------|
| `✗ Cassia客户端未启动` | 网络问题 | 检查网络配置 |
| `扫描到信标数量: 0` | 无信标 | 检查BLE标签 |
| `✗ 无匹配信标（距离差都>2m）` | 距离不匹配 | 调整位置或增大容差 |
| `⚠ 无深度信息` | 深度相机问题 | 检查Orbbec连接 |

### 车牌识别问题诊断

| 输出 | 问题 | 解决方案 |
|------|------|---------|
| `✗ 车牌识别器未初始化` | HyperLPR问题 | 检查安装 |
| `✗ ROI太小` | 车辆太小 | 靠近或放大图片 |
| `识别结果数量: 0` | 无车牌 | 改用清晰车牌图片 |
| `✗ 车牌识别异常: ...` | 格式错误 | 检查图像格式 |

---

## 手动测试BLE

如果系统中BLE不工作，单独测试：

```bash
cd /home/liubo/Download/deepstream-vehicle-detection/python_apps
python3 cassia_local_client.py 192.168.40.1
```

应该看到：
```
连接到Cassia路由器: 192.168.40.1
扫描信标中...
发现 1 个信标: [AA:BB:CC: -60dBm, 2.1m]
```

如果没有输出 → Cassia路由器或网络有问题

---

## 总结

**已实现的功能：**
- ✅ 相机深度测量
- ✅ BLE信标距离估算（RSSI → 距离）
- ✅ 距离对比匹配（容差2米）
- ✅ 详细调试输出
- ✅ 车牌识别（带调试信息）

**现在重新测试，查看终端输出，根据调试信息判断问题所在！**





