# 工程机械实时识别系统配置文件

# ============================================
# 网络配置
# ============================================
network:
  cassia_ip: "192.168.3.26"      # Cassia蓝牙路由器IP地址（工地部署：通过POE交换机连接到4G路由器）
  camera_id: "camera_01"          # 摄像头ID（用于白名单过滤）

# ============================================
# 检测参数
# ============================================
detection:
  conf_threshold: 0.75            # 检测置信度阈值 (0.0-1.0)，提高以减少误检和闪烁（从0.7提高到0.75）
  iou_threshold: 0.5              # NMS的IoU阈值 (0.0-1.0)，适中以保持检测稳定性
  model_path: "models/custom_yolo.engine"  # TensorRT模型文件路径
  # 连续帧验证（减少假阳性）- 增强版
  multi_frame_validation:
    enabled: true                  # 是否启用连续帧验证
    min_frames: 5                 # 最小连续帧数（从3增加到5，提高验证严格度）
    min_occurrence_ratio: 0.8     # 最小出现频率（从0.7提高到0.8，更严格）
    validation_window: 10          # 验证窗口大小（从5增加到10，提高稳定性）
    iou_threshold: 0.4            # 帧间匹配的IoU阈值（从0.5降到0.4，允许更大位置变化）

# ============================================
# 跟踪参数
# ============================================
tracking:
  tracker_type: "bytetrack"       # 跟踪器类型: "simple_iou" 或 "bytetrack"
  # Simple IoU跟踪器参数
  iou_threshold: 0.4              # 跟踪匹配的IoU阈值 (0.0-1.0)
  max_age: 60                     # 跟踪消失的最大帧数
  # ByteTrack跟踪器参数
  track_thresh: 0.5               # 跟踪阈值（提高以减少低质量跟踪）
  high_thresh: 0.7                # 高置信度阈值（与检测阈值一致）
  match_thresh: 0.4               # IoU匹配阈值（Phase 2优化：降低到0.4以提高跟踪稳定性，容忍更大位置变化）
  track_buffer: 200               # 跟踪缓冲区大小（Phase 2优化：增大到200，防止短暂遮挡或静止时ID丢失）
  min_track_confidence: 0.7       # 跟踪最小置信度阈值（原硬编码0.7，用于过滤低置信度检测）

# ============================================
# 警报去重参数
# ============================================
alert_dedup:
  time_window: 30.0               # 去重时间窗口（秒），原硬编码30.0
  iou_threshold: 0.5              # 去重IoU阈值，原硬编码0.5
  position_time_window: 10.0      # 位置重叠检查的时间窗口（秒），原硬编码10.0

# ============================================
# 文件路径配置
# ============================================
paths:
  beacon_whitelist: "beacon_whitelist.yaml"  # 信标白名单配置文件路径
  log_file: "/tmp/vehicle_detection.log"     # 日志文件路径
  alert_log_file: "/tmp/vehicle_alerts.json" # 报警记录文件路径（JSON格式）
  shared_frame_file: "/tmp/orbbec_shared_frame.npy"  # 共享RGB帧文件路径
  shared_depth_file: "/tmp/orbbec_shared_depth.npy" # 共享深度帧文件路径
  snapshot_dir: "/tmp/vehicle_snapshots"     # 车辆快照保存目录
  detection_db_path: "detection_results.db"  # 检测结果数据库路径（SQLite）

# ============================================
# 云端上传配置
# ============================================
cloud:
  enabled: true                               # 是否启用云端上传
  api_base_url: "http://123.249.9.250:8000"  # 云端服务器地址
  api_key: "kS3EhgTObprA48ruPkMg08DRX95x8ftv" # API密钥
  upload_interval: 10                         # 上传间隔（秒）
  max_image_size_mb: 10                       # 最大图片大小（MB），提高以支持更高分辨率
  enable_image_upload: true                   # 是否上传图片
  enable_alert_upload: true                   # 是否上传警报
  retry_attempts: 3                          # 重试次数
  retry_delay: 2.0                            # 重试延迟（秒）
  save_snapshots: true                        # 是否保存本地快照
  beacon_whitelist_update_interval: 60        # 信标白名单更新间隔（秒），默认1分钟（更实时）
  enable_cloud_whitelist: true                # 是否启用云端信标白名单（优先于本地配置）
  enable_monitoring_snapshot: true            # 是否启用定时上传监控截图（证明系统正在正常监控）
  monitoring_snapshot_interval: 600           # 监控截图上传间隔（秒），默认10分钟

# ============================================
# 深度测量参数
# ============================================
depth:
  min_range: 0.1                  # 最小深度范围（米）
  max_range: 10.0                 # 最大深度范围（米）
  method: "median"               # 深度测量方法: median/mean/min
  invalid_min: 0                  # 无效深度最小值（毫米，通常为0）
  invalid_max: 65535              # 无效深度最大值（毫米，通常为65535）
  # Phase 2优化: 深度测量时间平滑
  smoothing:
    enabled: true                 # 是否启用时间平滑
    method: "ema"                 # 平滑方法: "ema" (指数移动平均) 或 "median" (滑动中位数)
    alpha: 0.7                    # EMA系数 (0-1)，值越大对新值权重越高
    window_size: 5                # 滑动窗口大小（用于median方法）
    min_samples: 3                # 最小样本数，达到此数量后才开始平滑
  # 图像质量优化: 优先使用未压缩格式（RGB/BGR）而非MJPEG压缩格式
  # 这样可以获得更清晰的图像，提高LPR识别准确率
  prefer_uncompressed_format: true  # 是否优先选择未压缩格式（RGB/BGR）

# ============================================
# 车牌识别(LPR)配置
# ============================================
lpr:
  # Phase 2优化: LPR最佳帧选取
  best_frame_selection:
    enabled: true                 # 是否启用最佳帧选取
    quality_threshold: 0.6        # 质量分数阈值，达到此值后立即触发
    max_wait_frames: 30           # 最多等待帧数，超时后使用当前最佳帧
    reuse_result: true            # 识别成功后复用结果，避免重复识别

# ============================================
# 警报配置
# ============================================
alert:
  # Phase 2优化: 徘徊判定（减少路过车辆的误报）
  loitering:
    enabled: true                 # 是否启用徘徊判定
    min_duration: 10.0            # 最少停留时间（秒）
    min_area_ratio: 0.05          # 最小画面占比（0-1），太小可能是边缘路过
    min_movement_ratio: 0.1       # 最小移动比例（归一化），小于此值认为是徘徊
    apply_to_unregistered_only: true  # 只对未备案车辆应用徘徊判定

# ============================================
# 信标匹配时空一致性配置
# ============================================
beacon_match:
  temporal_consistency:
    enabled: true                 # 是否启用时空一致性验证
    min_consistent_frames: 5      # 连续N帧匹配才锁定（默认5帧）
    max_distance_error: 1.0       # 距离误差阈值（米），超过此值重置计数器
    reset_on_track_end: true      # 跟踪结束时重置匹配状态

# ============================================
# 日志配置
# ============================================
logging:
  level: "INFO"                   # 日志级别: DEBUG/INFO/WARNING/ERROR
  file_enabled: true              # 是否启用文件日志
  console_enabled: true            # 是否启用控制台日志
  max_file_size_mb: 10            # 单个日志文件最大大小（MB）
  backup_count: 5                 # 保留的日志文件备份数量

# ============================================
# 性能配置
# ============================================
performance:
  # 性能模式: "quality" (质量优先, 1080p, 25-30 FPS)
  #          "balanced" (平衡模式, 720p, 40-50 FPS)
  #          "speed" (速度优先, 720p, 50+ FPS)
  mode: "quality"                 # 性能模式选择
  input_resolution: [1920, 1080]  # 输入分辨率 [width, height]
  frame_skip: 0                   # 跳帧数 (0=不跳帧, 1=跳1帧)
  
  # 性能监控
  monitor_enabled: true            # 是否启用性能监控
  fps_update_interval: 10         # FPS更新间隔（帧数）
  gpu_monitor_enabled: true       # 是否监控GPU使用率
  memory_monitor_enabled: true     # 是否监控内存使用

# ============================================
# 错误恢复配置
# ============================================
recovery:
  camera_retry_enabled: true      # 是否启用相机自动重连
  camera_retry_interval: 5.0     # 相机重连间隔（秒）
  camera_max_retries: 10         # 相机最大重试次数（0表示无限重试）
  
  cassia_retry_enabled: true      # 是否启用Cassia自动重连
  cassia_retry_interval: 3.0     # Cassia重连间隔（秒）
  cassia_max_retries: 10         # Cassia最大重试次数（0表示无限重试）
  
  graceful_degradation: true      # 是否启用优雅降级（部分功能失效时继续运行）

# ============================================
# 数据留存配置
# ============================================
data_retention:
  # 数据库留存策略
  database:
    enabled: true                  # 是否启用数据库留存
    max_records: 10000             # 最大记录数（循环写入，超过后删除最旧记录）
    retention_days: 30             # 保留天数（超过此天数的记录会被清理）
    auto_cleanup: true             # 是否自动清理旧记录
    cleanup_interval_hours: 24     # 自动清理间隔（小时）
  
  # 快照留存策略
  snapshots:
    enabled: true                  # 是否启用快照留存
    max_count: 1000                # 最大快照数量（循环写入，超过后删除最旧快照）
    max_size_mb: 500               # 最大总大小（MB，超过后删除最旧快照）
    retention_days: 7              # 保留天数（超过此天数的快照会被清理）
    auto_cleanup: true             # 是否自动清理旧快照
    cleanup_interval_hours: 6     # 自动清理间隔（小时）
  
  # 监控截图留存策略
  monitoring_snapshots:
    enabled: true                  # 是否启用监控截图留存
    max_count: 500                 # 最大监控截图数量
    max_size_mb: 200               # 最大总大小（MB）
    retention_days: 3              # 保留天数
    auto_cleanup: true             # 是否自动清理
    cleanup_interval_hours: 12     # 自动清理间隔（小时）

# ============================================
# 显示配置
# ============================================
display:
  window_name: "Vehicle Detection"  # 显示窗口名称
  font_size_large: 24              # 大字体大小
  font_size_small: 18              # 小字体大小
  label_offset_y: 30               # 标签在bbox上方的偏移（像素）
  wait_key_ms: 1                   # 显示刷新间隔（毫秒）
  enable_detailed_drawing: true    # 是否启用详细绘制（性能模式下可禁用）

# ============================================
# 性能模式预设（自动应用，无需手动修改）
# ============================================
# quality模式: 1080p, 全功能, 目标25-30 FPS
# balanced模式: 720p, 全功能, 目标40-50 FPS  
# speed模式: 720p, 简化绘制, 目标50+ FPS
# 注意: 实际分辨率由Orbbec相机决定，此处仅用于参考

