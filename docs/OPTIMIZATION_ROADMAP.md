# 优化路线图

## Phase 1: 紧急修复 ✅ 已完成

**状态**: ✅ 已完成并部署  
**完成时间**: 2025-12-14

### 已完成内容

1. ✅ **移除硬编码阈值** - 配置化所有阈值参数
2. ✅ **信标匹配时空一致性** - 实现连续帧匹配验证机制
3. ⚠️ **异步流水线强化** - 评估后发现当前实现已足够，暂缓实施

### Phase 1 成果

- ✅ 所有硬编码阈值已移至配置文件
- ✅ 信标匹配稳定性大幅提升（减少闪烁误报）
- ✅ 系统配置灵活性提高，便于现场调优

---

## Phase 2: 核心优化 ⏳ 待实施

**优先级**: ⭐⭐⭐⭐ (高优先级推荐)  
**预计工作量**: 2-3周

### 2.1 ByteTrack参数调优 ⭐⭐⭐⭐

**目标**: 提升跟踪稳定性，减少ID切换

**优化内容**:
- 调整 `match_thresh` (当前0.5 → 建议0.4)
- 增大 `track_buffer` (当前100 → 建议200)
- 针对工地场景优化（车辆移动缓慢，易遮挡）

**配置示例**:
```yaml
tracking:
  tracker_type: "bytetrack"
  track_thresh: 0.5
  high_thresh: 0.7
  match_thresh: 0.4        # 降低：容忍更大位置变化
  track_buffer: 200        # 增大：防止短暂遮挡时ID丢失
```

**预期效果**:
- Track ID切换率降低
- 静止车辆不再丢失ID
- 遮挡后恢复跟踪更稳定

---

### 2.2 深度测量时间平滑 ⭐⭐⭐⭐

**目标**: 提升深度测量稳定性，减少波动

**现状**:
- ✅ 已有鲁棒方法 (`get_depth_at_bbox_bottom_robust`)
- ⚠️ 缺少时间维度平滑

**优化方案**: 实现滑动平均/指数移动平均

**配置示例**:
```yaml
depth:
  smoothing:
    enabled: true
    method: "ema"          # "ema" 或 "median"
    alpha: 0.7             # EMA系数
    window_size: 5         # 滑动窗口大小
```

**预期效果**:
- 深度值更稳定
- 减少距离测量波动
- 提升信标匹配准确性

---

### 2.3 LPR最佳帧选取 ⭐⭐⭐⭐

**目标**: 提升车牌识别成功率，减少算力浪费

**现状**:
- ⚠️ 对每个新track立即提交识别（可能不是最佳帧）
- ⚠️ 可能浪费算力在模糊、远距离、角度差的帧上

**优化方案**: 
1. 实现帧质量评分机制
2. 等待最佳帧出现后再触发识别
3. 识别成功后复用结果，避免重复识别

**配置示例**:
```yaml
lpr:
  best_frame_selection:
    enabled: true
    quality_threshold: 0.6      # 质量分数阈值
    max_wait_frames: 30         # 最多等待帧数
    reuse_result: true          # 识别成功后复用
    retry_on_failure: false     # 识别失败后是否重试
```

**预期效果**:
- 识别成功率提升
- 算力使用更高效
- 减少重复识别开销

---

### 2.4 徘徊判定 ⭐⭐⭐⭐

**目标**: 减少误报，只对真正停留的车辆报警

**现状**:
- ⚠️ 车辆一进入画面就触发报警
- ⚠️ 可能误报路过的车辆

**优化方案**: 
1. 检测车辆停留时间
2. 检测画面占比
3. 检测移动距离

**配置示例**:
```yaml
alert:
  loitering:
    enabled: true
    min_duration: 10.0         # 最少停留时间（秒）
    min_area_ratio: 0.05       # 最小画面占比
    min_movement_ratio: 0.1    # 最小移动比例（归一化）
```

**使用策略**:
- 只对"未备案"车辆应用徘徊判定
- 已备案车辆立即报警（无论是否徘徊）

**预期效果**:
- 显著减少路过车辆的误报
- 提高报警准确性
- 改善用户体验

---

## Phase 3: 进阶优化 🔮 按需实施

**优先级**: ⭐⭐⭐ (中优先级可选)  
**预计工作量**: 按需安排

### 3.1 动态ROI (Region of Interest) ⭐⭐⭐

**适用场景**: 固定相机位置的场景

**优化内容**:
- 定义感兴趣区域（ROI）
- 只在ROI内进行检测
- 减少背景干扰

**配置示例**:
```yaml
detection:
  roi_enabled: false
  roi_rect: [0.1, 0.2, 0.9, 0.9]  # [x1, y1, x2, y2] 归一化
```

**注意事项**:
- 只适用于相机位置固定的场景
- 需要额外的标定工作
- 相机移动后需要重新配置

---

### 3.2 自适应降频 (Adaptive Throttling) ⭐⭐⭐

**适用场景**: 性能受限的场景

**优化内容**:
- 监控推理性能
- 自动调整跳帧策略
- 维持目标FPS

**配置示例**:
```yaml
performance:
  adaptive_throttle:
    enabled: false  # 默认关闭，需要时启用
    target_fps: 15
    min_fps: 5
    max_fps: 30
```

**注意事项**:
- 默认关闭，仅在性能问题时启用
- 会影响检测的实时性
- 需要仔细调优参数

---

### 3.3 状态机引入 ⭐⭐⭐

**适用场景**: 业务逻辑复杂化时

**优化内容**:
- 引入状态机管理车辆状态
- 状态: Enter → Approaching → Identified → Leaving
- 便于扩展和调试

**注意事项**:
- 增加代码复杂度
- 当前逻辑已足够稳定
- 建议在需要更复杂业务逻辑时再引入

---

## 其他优化建议 📋

### 低优先级探索 (⭐⭐)

1. **多尺度检测策略**
   - 基于距离的动态阈值
   - 近距离提高阈值，远距离降低阈值

2. **时序轨迹分析**
   - 轨迹预测（卡尔曼滤波）
   - 异常轨迹检测
   - 轨迹聚类

3. **光照自适应**
   - 自动亮度/对比度调整
   - 多时段模型（日/夜）

4. **模型集成与投票**
   - 多模型投票机制
   - 提高检测鲁棒性

---

## 实施优先级总结

### 已完成 ✅
- Phase 1: 紧急修复（硬编码阈值、信标匹配时空一致性）

### 高优先级推荐 ⭐⭐⭐⭐
- Phase 2: 核心优化
  1. ByteTrack参数调优
  2. 深度测量时间平滑
  3. LPR最佳帧选取
  4. 徘徊判定

### 中优先级可选 ⭐⭐⭐
- Phase 3: 进阶优化
  1. 动态ROI（如适用）
  2. 自适应降频（按需）
  3. 状态机引入（按需）

### 低优先级探索 ⭐⭐
- 多尺度检测策略
- 时序轨迹分析
- 光照自适应
- 模型集成与投票

---

## 建议实施顺序

### 立即考虑（Phase 2）
1. **徘徊判定** - 显著减少误报，用户体验提升明显
2. **LPR最佳帧选取** - 提升识别成功率，减少算力浪费
3. **深度测量时间平滑** - 已有基础，实施简单
4. **ByteTrack参数调优** - 需要测试验证效果

### 按需考虑（Phase 3）
- 根据实际场景需求选择实施
- 动态ROI适合固定场景
- 自适应降频在性能问题时启用

---

## 决策建议

### 何时实施Phase 2？

**建议立即实施，如果**:
- 现场出现误报问题（路过车辆触发报警）→ 优先实施"徘徊判定"
- 车牌识别成功率低 → 优先实施"LPR最佳帧选取"
- 信标匹配距离波动大 → 优先实施"深度测量时间平滑"
- Track ID频繁切换 → 优先实施"ByteTrack参数调优"

**可以暂缓，如果**:
- Phase 1已解决当前主要问题
- 系统运行稳定，无明显问题
- 需要更多现场数据来验证优化效果

---

**文档版本**: 1.0  
**最后更新**: 2025-12-14  
**维护者**: DeepStream Vehicle Detection Team

