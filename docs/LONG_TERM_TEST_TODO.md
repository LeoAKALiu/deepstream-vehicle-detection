# 工地长期测试 - 待办事项清单

## 📋 概述

本文档列出了将系统部署到工地进行长期测试所需完成的所有工作，确保系统能够：
- ✅ 上电自动启动
- ✅ 稳定长期运行
- ✅ 自动恢复异常
- ✅ 收集和存储数据
- ✅ 远程监控和管理
- ✅ 与云端平台集成

---

## 🔴 P0 - 关键任务（必须完成）

### 1. 系统自启动配置

#### 1.1 Systemd 服务配置
- [ ] 创建 `vehicle-detection.service` systemd 服务文件
  - 设置服务依赖（网络、USB设备等）
  - 配置自动重启策略（失败后自动重启）
  - 设置服务超时和资源限制
  - 配置日志输出到 systemd journal
- [ ] 创建服务启动脚本 `scripts/start_vehicle_detection.sh`
  - 检查硬件设备连接状态（相机、Cassia路由器）
  - 检查配置文件完整性
  - 检查模型文件存在性
  - 设置环境变量（CUDA、Python路径等）
  - 启动主程序
- [ ] 创建服务停止脚本 `scripts/stop_vehicle_detection.sh`
  - 优雅关闭主程序
  - 清理临时文件
  - 保存状态信息
- [ ] 测试 systemd 服务
  - 验证服务启动/停止/重启
  - 验证开机自启动
  - 验证异常恢复

#### 1.2 硬件初始化检查
- [ ] 创建硬件检查脚本 `scripts/check_hardware.sh`
  - 检查 Orbbec 相机连接和权限
  - 检查 Cassia 路由器网络连接
  - 检查 USB 设备（相机、路由器）
  - 检查 GPU 可用性（TensorRT）
  - 检查磁盘空间（至少保留 20% 空间）
- [ ] 在主程序启动前执行硬件检查
  - 如果硬件检查失败，记录错误并退出
  - 发送硬件状态到云端（如果可用）

#### 1.3 网络配置和检查
- [ ] 创建网络检查脚本 `scripts/check_network.sh`
  - 检查 Cassia 路由器 IP 连通性
  - 检查互联网连接（用于云端上传）
  - 检查 DNS 解析
  - 检查网络延迟
- [ ] 网络故障处理
  - 网络断开时继续本地运行
  - 网络恢复后自动重连云端
  - 本地缓存待上传数据

---

### 2. 异常处理和自动恢复

#### 2.1 程序异常恢复
- [ ] 实现看门狗机制
  - 监控主程序进程状态
  - 检测程序崩溃或卡死
  - 自动重启程序
- [ ] 实现健康检查
  - 定期检查相机帧率（FPS）
  - 检查检测算法是否正常工作
  - 检查内存泄漏
  - 检查 GPU 使用率异常
- [ ] 异常日志记录
  - 记录所有异常和错误
  - 记录系统资源使用情况
  - 记录异常发生时间戳

#### 2.2 硬件异常处理
- [ ] 相机断开重连
  - 检测相机连接状态
  - 自动重新初始化相机
  - 记录相机异常事件
- [ ] Cassia 路由器异常处理
  - 检测路由器连接状态
  - 自动重连路由器
  - 降级模式（无信标匹配时继续运行）
- [ ] 磁盘空间管理
  - 监控磁盘使用率
  - 自动清理旧日志和视频
  - 磁盘空间不足时停止录制

#### 2.3 系统资源监控
- [ ] 创建资源监控脚本 `scripts/monitor_resources.sh`
  - CPU 使用率监控
  - 内存使用率监控
  - GPU 使用率和温度监控
  - 磁盘 I/O 监控
- [ ] 资源告警机制
  - CPU/内存/GPU 使用率过高时告警
  - 温度过高时告警
  - 发送告警到云端

---

### 3. 数据收集和存储管理

#### 3.1 日志管理
- [ ] 配置日志轮转
  - 使用 `logrotate` 或 Python `RotatingFileHandler`
  - 设置日志文件大小限制（如 100MB）
  - 保留最近 N 天的日志（如 30 天）
  - 压缩旧日志文件
- [ ] 日志分类存储
  - 系统日志（启动、停止、错误）
  - 检测日志（车辆检测、匹配结果）
  - 性能日志（FPS、延迟、资源使用）
  - 云端上传日志
- [ ] 日志清理策略
  - 定期清理过期日志
  - 保留关键错误日志
  - 上传重要日志到云端

#### 3.2 视频录制管理
- [ ] 视频存储策略
  - 设置视频保存目录和大小限制
  - 按日期/时间组织视频文件
  - 自动删除旧视频（保留最近 N 天）
  - 重要事件视频永久保存
- [ ] 视频压缩和转码
  - 录制完成后自动压缩视频
  - 降低视频分辨率/帧率以节省空间
  - 使用 H.264/H.265 编码
- [ ] 视频上传
  - 重要事件视频优先上传
  - 断点续传机制
  - 上传失败时本地保留

#### 3.3 检测结果存储
- [ ] 检测结果数据库
  - 使用 SQLite 或 JSON 文件存储检测结果
  - 记录车辆信息（类型、时间、位置、状态）
  - 记录信标匹配结果
  - 记录车牌识别结果
- [ ] 数据导出功能
  - 支持导出 CSV/JSON 格式
  - 支持按时间范围导出
  - 支持按车辆类型导出
- [ ] 数据备份
  - 定期备份检测结果
  - 备份到外部存储或云端

#### 3.4 快照管理
- [ ] 快照存储策略
  - 设置快照保存目录
  - 按日期组织快照文件
  - 自动清理旧快照
- [ ] 快照压缩
  - 自动压缩快照图片
  - 降低图片分辨率以节省空间

---

### 4. 远程监控和管理

#### 4.1 SSH 远程访问
- [ ] 配置 SSH 服务
  - 启用 SSH 服务
  - 配置 SSH 密钥认证
  - 设置 SSH 端口（如 22 或自定义端口）
  - 配置防火墙规则
- [ ] SSH 安全配置
  - 禁用密码登录（仅密钥）
  - 限制登录 IP（如仅允许特定 IP）
  - 配置 SSH 超时
  - 记录 SSH 登录日志

#### 4.2 系统状态监控
- [ ] 创建状态监控脚本 `scripts/system_status.sh`
  - 系统运行时间
  - 服务状态（主程序、相机、路由器）
  - 硬件状态（温度、资源使用）
  - 最近检测统计
- [ ] 状态 API 接口
  - 创建简单的 HTTP API 服务器
  - 提供系统状态查询接口
  - 提供日志查看接口
  - 提供配置查看接口

#### 4.3 远程控制
- [ ] 远程重启功能
  - 通过 SSH 或 API 远程重启服务
  - 远程重启系统
- [ ] 远程配置更新
  - 通过 SSH 或 API 更新配置文件
  - 验证配置有效性
  - 重启服务应用配置

---

## 🟡 P1 - 重要任务（建议完成）

### 5. 云端集成和API对接

#### 5.1 云端API对接
- [ ] 完善云端客户端
  - 实现心跳机制（定期发送系统状态）
  - 实现配置同步（从云端获取配置）
  - 实现远程控制（接收云端指令）
- [ ] 数据上传优化
  - 批量上传检测结果
  - 断点续传机制
  - 上传队列管理
  - 上传失败重试策略
- [ ] API 认证和安全
  - 实现 API 密钥认证
  - 实现请求签名验证
  - 实现 HTTPS 通信

#### 5.2 云端配置管理
- [ ] 配置同步功能
  - 从云端获取最新配置
  - 本地配置与云端配置对比
  - 配置更新后自动重启服务
- [ ] 白名单同步
  - 从云端同步信标白名单
  - 白名单更新后自动重载

#### 5.3 云端告警
- [ ] 告警规则配置
  - 未备案车辆告警
  - 系统异常告警
  - 硬件故障告警
- [ ] 告警通知
  - 发送告警到云端
  - 告警级别分类（紧急、警告、信息）
  - 告警去重（避免重复告警）

---

### 6. 性能监控和报告

#### 6.1 性能指标收集
- [ ] 检测性能指标
  - FPS（帧率）
  - 检测延迟
  - 检测准确率
  - 跟踪稳定性
- [ ] 系统性能指标
  - CPU/GPU/内存使用率
  - 温度监控
  - 磁盘 I/O
  - 网络带宽
- [ ] 业务指标
  - 检测车辆数量统计
  - 已备案/未备案车辆比例
  - 信标匹配成功率
  - 车牌识别准确率

#### 6.2 性能报告生成
- [ ] 日报生成
  - 每日检测统计
  - 系统运行时间
  - 异常事件汇总
- [ ] 周报/月报生成
  - 性能趋势分析
  - 异常事件分析
  - 系统优化建议
- [ ] 报告上传
  - 自动生成报告
  - 上传报告到云端
  - 本地保存报告

---

### 7. 测试和验证

#### 7.1 自启动测试
- [ ] 测试系统重启后自动启动
- [ ] 测试断电恢复后自动启动
- [ ] 测试服务异常后自动恢复
- [ ] 测试硬件断开后自动重连

#### 7.2 长期稳定性测试
- [ ] 连续运行 24 小时测试
- [ ] 连续运行 7 天测试
- [ ] 连续运行 30 天测试
- [ ] 监控内存泄漏
- [ ] 监控性能下降

#### 7.3 异常场景测试
- [ ] 网络断开测试
- [ ] 相机断开测试
- [ ] 路由器断开测试
- [ ] 磁盘空间不足测试
- [ ] 系统资源耗尽测试

---

## 🟢 P2 - 优化任务（可选）

### 8. 系统优化

#### 8.1 性能优化
- [ ] 优化检测算法性能
- [ ] 优化内存使用
- [ ] 优化磁盘 I/O
- [ ] 优化网络传输

#### 8.2 功能增强
- [ ] 添加更多检测类别
- [ ] 优化信标匹配算法
- [ ] 优化车牌识别准确率
- [ ] 添加车辆轨迹分析

#### 8.3 用户体验
- [ ] 创建 Web 管理界面
- [ ] 添加实时视频流查看
- [ ] 添加历史数据查询
- [ ] 添加数据可视化

---

## 📝 实施计划

### 阶段 1：基础自启动（1-2 天）
1. 创建 systemd 服务
2. 创建硬件检查脚本
3. 测试自启动功能

### 阶段 2：异常处理（2-3 天）
1. 实现看门狗机制
2. 实现健康检查
3. 实现异常恢复

### 阶段 3：数据管理（2-3 天）
1. 配置日志轮转
2. 实现视频管理
3. 实现数据存储

### 阶段 4：远程监控（2-3 天）
1. 配置 SSH
2. 创建状态监控
3. 创建远程控制

### 阶段 5：云端集成（3-5 天）
1. 完善云端客户端
2. 实现配置同步
3. 实现告警功能

### 阶段 6：测试验证（3-5 天）
1. 自启动测试
2. 长期稳定性测试
3. 异常场景测试

---

## 🔧 工具和脚本清单

需要创建的脚本：
- [ ] `scripts/vehicle-detection.service` - systemd 服务文件
- [ ] `scripts/start_vehicle_detection.sh` - 启动脚本
- [ ] `scripts/stop_vehicle_detection.sh` - 停止脚本
- [ ] `scripts/check_hardware.sh` - 硬件检查脚本
- [ ] `scripts/check_network.sh` - 网络检查脚本
- [ ] `scripts/monitor_resources.sh` - 资源监控脚本
- [ ] `scripts/system_status.sh` - 系统状态脚本
- [ ] `scripts/setup_auto_start.sh` - 自启动安装脚本
- [ ] `scripts/cleanup_old_data.sh` - 数据清理脚本
- [ ] `scripts/backup_data.sh` - 数据备份脚本

需要创建的文档：
- [ ] `docs/DEPLOYMENT_GUIDE.md` - 部署指南
- [ ] `docs/TROUBLESHOOTING.md` - 故障排除指南
- [ ] `docs/MONITORING_GUIDE.md` - 监控指南

---

## ✅ 验收标准

系统可以认为准备就绪，当满足以下条件：
1. ✅ 系统上电后自动启动，无需人工干预
2. ✅ 系统异常后自动恢复，无需人工干预
3. ✅ 系统可以稳定运行 7 天以上
4. ✅ 所有数据正确收集和存储
5. ✅ 可以通过远程方式监控和管理系统
6. ✅ 可以与云端平台正常通信
7. ✅ 所有关键功能经过测试验证

---

## 📞 联系和支持

如有问题或需要帮助，请参考：
- 项目文档：`docs/PROJECT_DOCUMENTATION.md`
- 故障排除：`docs/TROUBLESHOOTING.md`
- 系统日志：`/tmp/vehicle_detection.log`

