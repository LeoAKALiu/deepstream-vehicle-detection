# 前端图像分辨率优化修复

## 修复时间
2024-12-08

## 问题描述
前端接收到的图像分辨率很低，影响显示质量。

## 问题分析

### 发现的问题
1. **最小分辨率太低**: 320×240，对于前端显示来说太低
2. **最大分辨率限制**: 1920，可能限制了高分辨率图像的保存
3. **压缩质量过低**: 从85降到30，导致图像质量严重下降
4. **文件大小限制**: 5MB限制可能导致高分辨率图像被过度压缩

## 修复内容

### 1. 提高最小分辨率 ✅
- **之前**: 320×240
- **之后**: **640×480**（提高前端显示质量）

### 2. 提高最大分辨率限制 ✅
- **之前**: 1920（单边最大）
- **之后**: **2560**（支持更高分辨率）

### 3. 提高压缩质量 ✅
- **之前**: 85-30（质量范围）
- **之后**: **95-70**（保持高质量，最低不低于70）

### 4. 增加文件大小限制 ✅
- **之前**: 5MB
- **之后**: **10MB**（支持更高分辨率图像）

## 修改的文件

### 1. `test_system_realtime.py`
**修改位置**: `_save_snapshot_and_upload()` 方法

```python
# 之前
min_width, min_height = 320, 240
max_dimension = 1920

# 之后
min_width, min_height = 640, 480  # 提高最小分辨率
max_dimension = 2560  # 提高最大分辨率限制
```

### 2. `jetson-client/cloud_client.py`
**修改位置**: `_compress_image()` 方法

```python
# 之前
min_width, min_height = 320, 240
max_dimension = 1920
quality = 85  # 最低到30

# 之后
min_width, min_height = 640, 480  # 提高最小分辨率
max_dimension = 2560  # 提高最大分辨率限制
quality = 95  # 最低到70，保持高质量
```

### 3. `config.yaml`
**修改位置**: `cloud.max_image_size_mb`

```yaml
# 之前
max_image_size_mb: 5

# 之后
max_image_size_mb: 10  # 提高文件大小限制
```

## 预期效果

### 图像质量提升
- ✅ **最小分辨率**: 640×480（之前320×240），前端显示更清晰
- ✅ **最大分辨率**: 2560（之前1920），支持更高分辨率图像
- ✅ **压缩质量**: 95-70（之前85-30），图像质量显著提升
- ✅ **文件大小**: 10MB限制（之前5MB），减少过度压缩

### 前端显示效果
- **更清晰的图像**: 最小640×480分辨率，细节更丰富
- **更好的质量**: 压缩质量95-70，减少压缩伪影
- **更高的分辨率**: 支持最高2560分辨率，适应大屏显示

## 技术细节

### 分辨率处理流程

1. **快照裁剪**:
   - 从原始帧（1920×1080）裁剪车辆区域
   - 扩展20%边界，增加上下文
   - 确保最小640×480分辨率

2. **分辨率调整**:
   - 如果太小，放大到最小640×480
   - 如果太大，缩小到最大2560（保持宽高比）

3. **图像压缩**:
   - 优先保持分辨率
   - 从质量95开始压缩
   - 最低质量不低于70
   - 如果仍然太大，才缩小尺寸

### 压缩策略

```
1. 保持原始分辨率（如果可能）
2. 从质量95开始压缩
3. 逐步降低质量（每次-5）
4. 最低质量不低于70
5. 如果仍然太大，才缩小尺寸（但保持最小640×480）
```

## 验证方法

### 1. 检查快照文件
```bash
# 查看快照目录
ls -lh /tmp/vehicle_snapshots/

# 检查图像尺寸
file snapshot_*.jpg
identify snapshot_*.jpg  # 如果安装了ImageMagick
```

### 2. 检查日志
启动时应该看到：
```
Image compressed: XXX KB -> YYY KB (size: 1920x1080)
```

### 3. 前端验证
- 检查前端接收到的图像分辨率
- 确认图像清晰度是否提升
- 确认是否有压缩伪影

## 注意事项

1. **文件大小**: 10MB限制可能增加网络传输时间，但图像质量更好
2. **存储空间**: 更高分辨率图像占用更多存储空间
3. **网络带宽**: 如果网络带宽有限，可能需要调整 `max_image_size_mb`
4. **性能影响**: 处理更高分辨率图像可能略微增加CPU占用

## 相关文件
- `test_system_realtime.py` - 快照保存逻辑（已优化）
- `jetson-client/cloud_client.py` - 图像压缩逻辑（已优化）
- `config.yaml` - 配置文件（已更新）

## 总结

✅ **最小分辨率**: 320×240 → 640×480
✅ **最大分辨率**: 1920 → 2560
✅ **压缩质量**: 85-30 → 95-70
✅ **文件大小限制**: 5MB → 10MB

所有优化已完成，前端现在应该能接收到更高分辨率的图像。

