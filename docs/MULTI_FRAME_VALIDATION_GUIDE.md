# 多帧验证功能说明

## 功能概述

多帧验证器用于减少假阳性检测，通过要求检测框在连续多帧中稳定出现来过滤掉不稳定的误检。

## 工作原理

1. **检测历史记录**: 为每个检测框维护历史记录（最近N帧）
2. **帧间匹配**: 使用IoU匹配同一检测框在不同帧中的出现
3. **验证条件**: 只有当检测框满足以下条件时才认为是有效检测：
   - 在验证窗口内出现至少 `min_frames` 次
   - 出现频率 >= `min_occurrence_ratio`

## 配置参数

在 `config.yaml` 中：

```yaml
detection:
  multi_frame_validation:
    enabled: true                  # 是否启用连续帧验证
    min_frames: 3                   # 最小连续帧数
    min_occurrence_ratio: 0.7      # 最小出现频率（0.0-1.0）
    validation_window: 5            # 验证窗口大小（帧数）
    iou_threshold: 0.5             # 帧间匹配的IoU阈值
```

## 参数说明

### min_frames
- **默认值**: 3
- **说明**: 检测框必须在至少N帧中出现才认为是有效检测
- **建议**: 
  - 静态图片测试: 可以设置为1-2（降低要求）
  - 实时视频: 3-5（更严格）

### min_occurrence_ratio
- **默认值**: 0.7
- **说明**: 在验证窗口内，检测框必须出现的频率
- **示例**: 如果 `validation_window=5`，`min_occurrence_ratio=0.7`，则检测框必须在5帧中至少出现 5×0.7=3.5≈4 次

### validation_window
- **默认值**: 5
- **说明**: 验证窗口大小（帧数），用于计算出现频率
- **建议**: 5-10帧

### iou_threshold
- **默认值**: 0.5
- **说明**: 帧间匹配的IoU阈值，用于判断是否为同一检测框
- **建议**: 0.4-0.6

## 使用场景

### 1. 实时视频检测
- **推荐配置**: `min_frames=3`, `min_occurrence_ratio=0.7`
- **效果**: 过滤掉闪烁的误检，只保留稳定的检测

### 2. 静态图片测试
- **推荐配置**: `min_frames=1`, `min_occurrence_ratio=0.3` 或 `enabled=false`
- **说明**: 静态图片只有一帧，多帧验证可能不太适用，可以降低要求或禁用

### 3. 高误检率场景
- **推荐配置**: `min_frames=5`, `min_occurrence_ratio=0.8`
- **效果**: 更严格的验证，进一步减少假阳性

## 工作流程

```
第1帧: 检测到3个框 → 记录历史，暂时允许通过（系统刚启动）
第2帧: 检测到3个框 → 匹配历史，更新记录，暂时允许通过
第3帧: 检测到3个框 → 匹配历史，更新记录，开始验证
  - 框1: 出现3次，频率=3/5=0.6 < 0.7 → 过滤
  - 框2: 出现3次，频率=3/5=0.6 < 0.7 → 过滤
  - 框3: 出现3次，频率=3/5=0.6 < 0.7 → 过滤
第4帧: 检测到2个框 → 匹配历史，更新记录
  - 框1: 出现4次，频率=4/5=0.8 >= 0.7 → 通过 ✓
  - 框2: 出现4次，频率=4/5=0.8 >= 0.7 → 通过 ✓
```

## 注意事项

1. **启动延迟**: 系统启动后的前N帧（`min_frames`）可能无法完全过滤假阳性
2. **静态图片**: 对于静态图片测试，建议降低 `min_frames` 或禁用验证
3. **性能影响**: 多帧验证会增加少量计算开销，但通常可以忽略

## 调优建议

如果仍然检测到多辆车：

1. **提高 min_frames**: 从3增加到5
2. **提高 min_occurrence_ratio**: 从0.7增加到0.8
3. **降低 iou_threshold**: 从0.5降低到0.4（更严格的匹配）
4. **结合NMS优化**: 同时提高 `detection.iou_threshold`

## 禁用方法

如果不需要多帧验证，可以在配置中禁用：

```yaml
detection:
  multi_frame_validation:
    enabled: false
```

---
*创建时间: 2025-11-24*


