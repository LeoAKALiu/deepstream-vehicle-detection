# 工程机械识别问题说明

## 🚨 核心问题

**当前YOLOv11模型无法识别挖掘机等工程机械！**

---

## 原因分析

### COCO数据集类别限制

当前使用的YOLOv11模型在**COCO数据集**上训练，包含80个类别。

**COCO包含的车辆类别：**
- ✅ `car` - 小汽车
- ✅ `truck` - 卡车
- ✅ `bus` - 公交车/大巴
- ✅ `motorcycle` - 摩托车
- ✅ `bicycle` - 自行车
- ✅ `train` - 火车
- ✅ `boat` - 船

**COCO不包含的类别：**
- ❌ `excavator` - 挖掘机
- ❌ `bulldozer` - 推土机
- ❌ `crane` - 起重机
- ❌ `concrete mixer` - 混凝土搅拌车
- ❌ `loader` - 装载机
- ❌ `grader` - 平地机

---

## 临时解决方案

### 方案1：使用Truck作为工程车辆替代（立即可用）✅

**修改类别映射：**
```python
VEHICLE_CLASSES = {
    'car': 'civilian',       # 小汽车 -> 社会车辆
    'truck': 'construction', # 卡车 -> 工程车辆 (临时)
    'bus': 'construction',   # 公交车 -> 工程车辆 (临时)
}
```

**测试方法：**
1. 使用卡车图片测试
2. 大型车辆图片（可能被识别为truck/bus）

**优点：**
- 无需重新训练模型
- 立即可用
- 系统逻辑完整（蓝牙信标、报警等）

**缺点：**
- 不够精确
- 可能误识别真实的卡车/公交车

---

### 方案2：更换专门的工程机械检测模型（推荐）🔧

需要寻找包含工程机械类别的数据集训练的模型。

**可用数据集：**

1. **Construction Site Safety Dataset**
   - 包含：excavator, bulldozer, crane, worker等
   - 开源数据集
   - 专门用于工地安全

2. **Heavy Equipment Dataset**
   - 工程机械专用
   - 包含多种工程车辆

3. **自定义数据集**
   - 收集工程机械图片
   - 标注并训练

**实施步骤：**
```bash
# 1. 获取包含工程机械的数据集
# 2. 使用YOLOv11训练
yolo train data=construction.yaml model=yolov11n.pt epochs=100

# 3. 导出ONNX
yolo export model=best.pt format=onnx

# 4. 转换TensorRT
trtexec --onnx=best.onnx --saveEngine=construction_yolo.engine --fp16

# 5. 替换现有模型
```

**时间成本：**
- 数据收集：1-2天
- 训练：4-8小时
- 测试优化：1-2天
- **总计：3-5天**

---

### 方案3：使用两阶段检测（混合方案）🔀

**流程：**
```
Stage 1: YOLOv11 (COCO) → 检测所有车辆
                          ↓
Stage 2: 工程机械分类器 → 判断是否为工程车辆
```

**实现：**
1. 用YOLOv11检测所有大型物体（truck, bus, car）
2. 对检测到的区域，用分类器判断是否为工程机械
3. 分类器可以很轻量（ResNet18即可）

**优点：**
- 利用现有YOLO
- 分类器训练简单
- 准确度高

**缺点：**
- 推理时间略增加
- 需要额外训练分类器

---

## 立即可行的调试步骤

### 步骤1：运行调试模式

```bash
cd /home/liubo/Download/deepstream-vehicle-detection
bash 调试检测.sh
```

**观察：**
- iPad上的图片是否被检测到任何类别？
- 如果检测到了，是什么类别？
- 置信度是多少？

### 步骤2：尝试不同图片

**建议测试图片顺序：**
1. ✅ **卡车图片**（最可能被识别）
2. 大型公交车图片
3. 挖掘机图片（黄色，轮廓清晰）

### 步骤3：调整测试条件

如果完全检测不到：

**检查距离和大小：**
```
iPad到相机距离: 1-2米
图片在屏幕上的尺寸: 占屏幕50-80%
```

**检查光线：**
- 避免屏幕反光
- 确保环境光充足
- 避免逆光

**检查角度：**
- 相机正对iPad
- 避免过大角度

---

## 推荐行动方案

### 短期（1-2天）

1. **立即：运行调试模式**
   ```bash
   bash 调试检测.sh
   ```

2. **使用卡车图片测试**
   - 搜索"大型卡车"图片
   - 确保图片清晰、占比大

3. **调整类别映射**
   - 将truck/bus暂时作为工程车辆
   - 完成系统功能测试

### 中期（3-7天）

1. **评估工程机械检测模型**
   - 搜索开源工程机械检测模型
   - 测试准确率

2. **如果找到合适模型**
   - 转换为TensorRT
   - 替换现有模型
   - 重新测试

### 长期（1-2周）

1. **自定义训练**
   - 收集工地现场图片
   - 标注工程机械
   - 训练专用模型

---

## 测试图片建议

### 可以被识别的：

**卡车（Truck）：**
- 大型货车
- 工程运输车
- 自卸车

**公交车（Bus）：**
- 大巴车
- 校车

### 无法被识别的：

- 挖掘机（目前）
- 推土机（目前）
- 起重机（目前）
- 其他工程机械（目前）

---

## 性能对比

| 方案 | 准确度 | 实施难度 | 时间成本 | 维护成本 |
|------|--------|---------|---------|---------|
| **临时（truck替代）** | ⭐⭐ | ⭐ | 立即 | 低 |
| **专用模型** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | 3-5天 | 中 |
| **两阶段检测** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 2-3天 | 中 |
| **自定义训练** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 1-2周 | 高 |

---

## 下一步

1. **立即运行：**
   ```bash
   cd /home/liubo/Download/deepstream-vehicle-detection
   bash 调试检测.sh
   ```

2. **用iPad显示卡车图片**

3. **观察是否检测到truck类别**

4. **根据结果决定下一步方案**

---

**如果调试模式能检测到truck，系统的其他功能（跟踪、蓝牙、报警）都是正常的，只需要更换合适的检测模型。**





