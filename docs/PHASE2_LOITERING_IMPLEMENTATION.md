# Phase 2 徘徊检测实施总结

## 实施时间
2025-12-14

## 实施内容

### ✅ 已完成

实现了徘徊检测功能，减少路过车辆的误报。

---

## 实施详情

### 1. 创建徘徊检测器模块

**文件**: `python_apps/loitering_detector.py`

**功能**:
- 检测车辆停留时间
- 检测画面占比（过滤边缘路过车辆）
- 检测移动距离（识别真正停留的车辆）

**关键类**:
- `LoiteringDetector`: 徘徊检测器主类
- `TrackPosition`: 位置信息数据类

---

### 2. 配置集成

**配置文件**: `config.yaml`

**新增配置段**:
```yaml
alert:
  loitering:
    enabled: true                 # 是否启用徘徊判定
    min_duration: 10.0            # 最少停留时间（秒）
    min_area_ratio: 0.05          # 最小画面占比（0-1）
    min_movement_ratio: 0.1       # 最小移动比例（归一化）
    apply_to_unregistered_only: true  # 只对未备案车辆应用
```

---

### 3. 代码集成

**集成位置**: `test_system_realtime.py`

#### 3.1 初始化

- 在 `__init__` 方法中初始化 `LoiteringDetector`
- 从配置文件读取参数
- 打印初始化日志

**代码位置**: 第1169-1183行

#### 3.2 更新逻辑

- 在 `check_construction_vehicle` 方法中更新徘徊检测器
- 为每个track维护位置历史

**代码位置**: 第1970-1974行

#### 3.3 判定逻辑

- **已备案车辆**: 立即报警（不应用徘徊判定）
- **未备案车辆**: 
  - 如果启用徘徊判定且只对未备案车辆应用
  - 检查是否满足徘徊条件
  - 如果不满足，暂不报警（返回None）
  - 如果满足，创建alert

**代码位置**: 第2008-2035行（类型不匹配），第2036-2059行（无信标匹配）

#### 3.4 清理逻辑

- 在跟踪清理时清理徘徊检测器状态
- 移除已结束track的位置历史

**代码位置**: 第2550-2552行

---

## 徘徊判定条件

车辆必须同时满足以下条件才被认为是"徘徊"：

1. **停留时间** >= `min_duration` (默认10秒)
2. **画面占比** >= `min_area_ratio` (默认0.05，过滤边缘路过车辆)
3. **移动距离** < `min_movement_ratio` (默认0.1，归一化到frame宽度)

---

## 使用策略

- **只对未备案车辆应用徘徊判定**
- **已备案车辆立即报警**（无论是否徘徊）
- **未备案车辆必须满足徘徊条件才报警**

---

## 测试验证

**测试脚本**: `tests/test_loitering_detector.py`

**测试结果**: ✅ 全部通过

测试覆盖：
1. ✅ 车辆停留（几乎不动）- 应该检测到徘徊
2. ✅ 车辆快速通过（移动距离大）- 不应该检测到徘徊
3. ✅ 停留时间不足 - 不应该检测到徘徊
4. ✅ 清理功能正常

---

## 配置参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `min_duration` | 10.0秒 | 最少停留时间，小于此值不报警 |
| `min_area_ratio` | 0.05 | 最小画面占比，太小可能是边缘路过 |
| `min_movement_ratio` | 0.1 | 最小移动比例（归一化），小于此值认为是徘徊 |
| `apply_to_unregistered_only` | true | 只对未备案车辆应用徘徊判定 |

---

## 预期效果

1. **减少误报**: 路过车辆不会触发报警
2. **提高准确性**: 只对真正停留的未备案车辆报警
3. **改善用户体验**: 减少不必要的报警通知

---

## 注意事项

1. **延迟报警**: 未备案车辆需要等待至少10秒（`min_duration`）才会报警
2. **配置调优**: 根据实际场景调整参数：
   - 如果误报多，可以增大 `min_duration`
   - 如果漏报多，可以减小 `min_duration`
   - 根据画面大小调整 `min_area_ratio`
3. **性能影响**: 徘徊检测计算开销很小，对系统性能影响可忽略

---

## 后续优化建议

1. **动态参数**: 根据实际场景动态调整参数
2. **多区域检测**: 检测车辆在不同区域的停留时间
3. **轨迹分析**: 结合轨迹分析提高准确性

---

**实施状态**: ✅ 完成  
**测试状态**: ✅ 全部通过  
**文档版本**: 1.0  
**最后更新**: 2025-12-14









