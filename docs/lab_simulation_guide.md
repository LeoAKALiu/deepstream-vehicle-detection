# 实验室模拟测试指南

## 概述

使用iPad展示车辆图片进行完整系统的模拟测试。

---

## 测试场景

### 场景1：已备案工程车辆（正常）
```
展示内容：工程机械图片（挖掘机/推土机/卡车等）
BLE标签：贴在iPad上
预期结果：✓ 检测到工程车辆 + 识别到BLE信标 → 正常通过，无报警
显示颜色：橙色边框
显示文字：工程车辆 (已备案)
```

### 场景2：未备案工程车辆（报警）
```
展示内容：工程机械图片（挖掘机/推土机/卡车等）
BLE标签：不贴标签
预期结果：⚠ 检测到工程车辆 + 未识别到BLE信标 → 触发报警
显示颜色：红色边框
显示文字：⚠ 未备案工程车辆！
终端输出：
  🚨 报警: 未备案工程车辆进入工地！
     Track ID: xxx
     距离: x.xx m
```

### 场景3：社会车辆（识别车牌）
```
展示内容：普通小汽车图片（带清晰车牌）
BLE标签：不贴标签
预期结果：✓ 检测到社会车辆 + 识别车牌号
显示颜色：绿色边框
显示文字：社会车辆 粤Bxxxxx
终端输出：
  🚗 社会车辆检测
     Track ID: xxx
     车牌号: 粤Bxxxxx
```

---

## 硬件准备

### 1. Orbbec Gemini 335L 相机
```bash
# 检查相机连接
lsusb | grep Orbbec

# 测试相机
cd /home/liubo/Download/deepstream-vehicle-detection/python_apps
python3 test_orbbec.py
```

### 2. Cassia蓝牙路由器
```bash
# 配置网络（如果未配置）
cd /home/liubo/Download/deepstream-vehicle-detection
sudo bash 配置Cassia-两个网口.sh

# 测试连接
ping -c 3 192.168.40.1

# 测试信标扫描
curl http://192.168.40.1/gap/nodes?event=1
```

### 3. iPad + 车辆图片
准备以下图片：
- **工程车辆**: 挖掘机、推土机、混凝土搅拌车、工程卡车等
- **社会车辆**: 小轿车（需要清晰可见车牌）

图片要求：
- 分辨率: 1024x768 或更高
- 车辆占画面比例: 30%-70%
- 光线良好，清晰可见

### 4. BLE信标标签
- 确保信标已开启（有LED指示灯闪烁）
- 电池电量充足
- MAC地址已知（可通过Cassia扫描获取）

---

## 测试步骤

### 准备阶段

1. **连接硬件**
   ```bash
   # 1) 连接Orbbec相机到Jetson USB 3.0接口
   # 2) 连接Cassia路由器到Jetson有线网口
   # 3) 打开BLE信标
   ```

2. **验证硬件**
   ```bash
   cd /home/liubo/Download/deepstream-vehicle-detection
   
   # 测试相机
   python3 python_apps/test_orbbec.py
   
   # 测试蓝牙路由器
   curl http://192.168.40.1/gap/nodes?event=1
   ```

3. **调整相机位置**
   - 将Orbbec相机对准iPad位置
   - 距离建议: 1-3米
   - 角度: 尽量垂直于iPad屏幕
   - 确保iPad完全在相机视野内

### 测试阶段

**启动系统**
```bash
cd /home/liubo/Download/deepstream-vehicle-detection
bash test_realtime_system.sh
```

**场景1: 已备案工程车辆**
1. 在iPad上显示工程车辆图片（全屏）
2. 将BLE信标贴在iPad背面或旁边（距离<1米）
3. 等待系统检测
4. 观察屏幕显示：
   - 应出现橙色边框
   - 标签显示"工程车辆 (已备案)"
   - 终端无报警信息

**场景2: 未备案工程车辆**
1. 继续显示工程车辆图片
2. 移除BLE信标（或关闭信标）
3. 等待3-5秒让系统重新识别
4. 观察系统反应：
   - 应出现红色边框
   - 标签显示"⚠ 未备案工程车辆！"
   - 终端显示报警信息：
     ```
     🚨 报警: 未备案工程车辆进入工地！
     ```

**场景3: 社会车辆**
1. 在iPad上切换到社会车辆图片（带车牌）
2. 确保BLE信标已移除
3. 等待系统检测
4. 观察识别结果：
   - 应出现绿色边框
   - 标签显示"社会车辆 粤Bxxxxx"
   - 终端显示车牌识别信息

**退出系统**
```
按 'q' 键退出
```

---

## 预期输出示例

### 系统启动输出
```
======================================================================
实时车辆检测系统初始化
======================================================================

【1. 加载TensorRT引擎】
✓ TensorRT引擎加载成功
  输入shape: (1, 3, 640, 640)
  输出shape: (1, 84, 8400)

【2. 初始化跟踪器】
✓ 跟踪器初始化完成

【3. 连接Cassia蓝牙路由器】
✓ Cassia客户端启动成功: 192.168.40.1

【4. 初始化Orbbec相机】
✓ Orbbec相机启动成功

【5. 初始化车牌识别】
✓ HyperLPR初始化成功

======================================================================
✓ 系统初始化完成！
======================================================================

开始实时检测...
按 'q' 退出
```

### 未备案工程车辆报警
```
======================================================================
🚨 报警: 未备案工程车辆进入工地！
   Track ID: 3
   距离: 2.45 m
======================================================================
```

### 社会车辆识别
```
======================================================================
🚗 社会车辆检测
   Track ID: 5
   车牌号: 粤B12345
======================================================================
```

### 测试结束统计
```
======================================================================
检测完成统计
======================================================================
总帧数: 1234
总报警: 3

车辆统计:
  已备案工程车辆: 1
  未备案工程车辆: 1
  社会车辆: 1
======================================================================
```

---

## 故障排除

### 问题1: 相机无法启动
```bash
# 检查USB连接
lsusb | grep Orbbec

# 检查权限
sudo bash 配置Orbbec权限.sh

# 重新插拔USB线
```

### 问题2: Cassia无法连接
```bash
# 检查网络连接
ip addr show enP8p1s0  # 或 enP1p1s0

# 重新配置网络
sudo bash 配置Cassia-两个网口.sh

# 测试连通性
ping 192.168.40.1
```

### 问题3: 检测不到车辆
**可能原因：**
- iPad图片太小 → 放大到全屏
- 距离太远 → 将iPad移近（1-2米）
- 光线太暗 → 增加环境光线
- 图片不清晰 → 更换高清图片

### 问题4: 车牌识别失败
**可能原因：**
- 车牌不清晰 → 使用更清晰的图片
- 车牌角度 → 调整iPad使车牌正对相机
- 光线反光 → 调整角度避免反光

### 问题5: BLE信标检测不到
```bash
# 手动测试信标扫描
curl http://192.168.40.1/gap/nodes?event=1

# 检查信标：
# 1) LED是否闪烁
# 2) 电池是否有电
# 3) 距离是否太远（应<3米）
```

---

## 高级配置

### 调整检测参数
编辑 `test_system_realtime.py`:

```python
# 置信度阈值（默认0.5）
def postprocess(self, output, conf_threshold=0.5, iou_threshold=0.4):

# IoU跟踪阈值（默认0.3）
class VehicleTracker:
    def __init__(self, iou_threshold=0.3):

# 跟踪最大消失帧数（默认30帧）
self.max_age = 30
```

### 禁用深度相机
如果不需要距离测量：
```bash
python3 test_system_realtime.py --no-depth
```

### 更换Cassia IP
```bash
python3 test_system_realtime.py --cassia-ip 192.168.1.27
```

---

## 测试记录表

| 场景 | 车辆类型 | BLE标签 | 预期结果 | 实际结果 | 通过 |
|------|---------|---------|---------|---------|------|
| 1 | 工程车辆 | ✓ | 正常，橙色 | | [ ] |
| 2 | 工程车辆 | ✗ | 报警，红色 | | [ ] |
| 3 | 社会车辆 | ✗ | 识别车牌，绿色 | | [ ] |

---

## 总结

完成所有测试后，系统应该能够：
- ✅ 准确检测工程车辆和社会车辆
- ✅ 通过BLE信标识别已备案工程车辆
- ✅ 对未备案工程车辆触发报警
- ✅ 识别社会车辆的车牌号
- ✅ 实时跟踪多个车辆
- ✅ 显示清晰的可视化结果

如有任何问题，请检查：
1. 硬件连接
2. 网络配置
3. 软件日志输出
4. 测试图片质量





