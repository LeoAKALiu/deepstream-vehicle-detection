# 4G流量需求分析与优化指南

## 概述

本文档分析车辆检测系统通过4G路由器上传数据所需的流量，并提供优化建议。

## 流量组成

系统上传的数据包括两部分：

1. **警报数据（JSON）**：每次检测的元数据
   - 大小：约 0.5 KB/条
   - 包含：车辆类型、时间戳、车牌号、置信度、距离、备案状态等

2. **图片数据（JPEG）**：车辆快照
   - 大小：取决于配置和压缩
   - 默认最大：5 MB（配置值）
   - 实际平均：约 200-500 KB（压缩后）

## 流量计算公式

```
每日流量 = (警报数 × 0.5 KB) + (警报数 × 图片数 × 平均图片大小)
每月流量 = 每日流量 × 30天 × 压缩系数 × 重传开销
```

其中：
- 压缩系数：0.7（压缩后约为原大小的70%）
- 重传开销：1.1（考虑10%的重传）

## 典型场景分析

### 场景1：低流量场景（小型工地）
- 每天检测：20辆车
- 平均图片：150 KB
- **每月流量：约 70 MB（0.07 GB）**
- **推荐套餐：1GB/月（约10-20元）**

### 场景2：中等流量场景（中型工地）
- 每天检测：50辆车
- 平均图片：200 KB
- **每月流量：约 230 MB（0.22 GB）**
- **推荐套餐：1GB/月（约10-20元）**

### 场景3：高流量场景（大型工地）
- 每天检测：100辆车
- 平均图片：300 KB
- **每月流量：约 680 MB（0.66 GB）**
- **推荐套餐：1GB/月（约10-20元）**

### 场景4：极高流量场景（超大型工地）
- 每天检测：200辆车
- 平均图片：400 KB
- **每月流量：约 1.8 GB**
- **推荐套餐：3GB/月（约20-30元）**

### 场景5：当前配置（默认）
- 每天检测：50辆车
- 平均图片：2 MB（压缩前，压缩后约800KB）
- **每月流量：约 2.3 GB**
- **推荐套餐：3GB/月（约20-30元）**

## 优化策略

### 策略1：降低图片质量（推荐）

**方法**：在 `config.yaml` 中降低 `max_image_size_mb`

```yaml
cloud:
  max_image_size_mb: 2  # 从5MB降低到2MB
```

**效果**：
- 图片大小减少约60%
- 每月流量从2.3GB降至约1GB
- 图片质量仍可满足识别需求

### 策略2：仅上传未备案车辆

**方法**：修改上传逻辑，只上传未备案车辆

**效果**：
- 假设50%车辆已备案，流量减少50%
- 每月流量从2.3GB降至约1.15GB

### 策略3：降低图片分辨率

**方法**：在压缩函数中降低最大分辨率

**当前设置**：
```python
max_dimension = 1920  # 最大1920像素
```

**优化设置**：
```python
max_dimension = 1280  # 降低到1280像素
```

**效果**：
- 图片大小减少约30-40%
- 每月流量从2.3GB降至约1.4GB

### 策略4：批量上传（高级）

**方法**：本地缓存，定期批量上传

**效果**：
- 减少网络请求开销
- 可以进一步压缩
- 适合网络不稳定场景

### 策略5：选择性上传

**方法**：仅上传重要事件（未备案车辆、异常情况）

**效果**：
- 流量减少70-80%
- 每月流量从2.3GB降至约0.5GB

## 实际使用建议

### 1. 初始配置

建议使用以下配置开始：

```yaml
cloud:
  enabled: true
  max_image_size_mb: 2          # 降低到2MB
  enable_image_upload: true
  enable_alert_upload: true
```

**预期流量**：约1GB/月

### 2. 监控实际使用

运行系统1-2周后，检查实际流量：

```bash
# 查看上传队列统计
# 查看日志文件大小
# 使用4G路由器管理界面查看流量
```

### 3. 根据实际情况调整

- **流量充足**：可以适当提高图片质量
- **流量紧张**：进一步降低图片大小或启用选择性上传

## 4G套餐推荐

### 中国移动
- **1GB/月**：约10-20元（适合低流量场景）
- **3GB/月**：约20-30元（适合中等流量场景）
- **10GB/月**：约50-80元（适合高流量场景）

### 中国联通
- **1GB/月**：约10-20元
- **3GB/月**：约20-30元
- **10GB/月**：约50-80元

### 中国电信
- **1GB/月**：约10-20元
- **3GB/月**：约20-30元
- **10GB/月**：约50-80元

### 物联网专用卡
- **流量池套餐**：适合多设备场景
- **按量计费**：适合流量波动大的场景
- **包年套餐**：适合长期使用，价格更优惠

## 流量监控

### 方法1：使用评估工具

```bash
cd /home/liubo/Download/deepstream-vehicle-detection
python3 scripts/estimate_4g_traffic.py

# 自定义参数
python3 scripts/estimate_4g_traffic.py --alerts-per-day 100 --image-size-kb 300

# 查看不同场景
python3 scripts/estimate_4g_traffic.py --scenarios
```

### 方法2：监控实际流量

1. **4G路由器管理界面**
   - 登录路由器管理界面
   - 查看流量统计
   - 设置流量告警

2. **系统日志**
   - 查看上传日志
   - 统计上传次数和大小

3. **云端服务器**
   - 统计接收到的数据量
   - 分析实际使用情况

## 优化配置示例

### 配置1：最小流量（仅警报）

```yaml
cloud:
  enabled: true
  enable_image_upload: false  # 不上传图片
  enable_alert_upload: true
```

**流量**：约15 MB/月（每天50辆车）

### 配置2：平衡配置（推荐）

```yaml
cloud:
  enabled: true
  max_image_size_mb: 2       # 2MB限制
  enable_image_upload: true
  enable_alert_upload: true
```

**流量**：约1 GB/月（每天50辆车）

### 配置3：高质量配置

```yaml
cloud:
  enabled: true
  max_image_size_mb: 5       # 5MB限制
  enable_image_upload: true
  enable_alert_upload: true
```

**流量**：约2.3 GB/月（每天50辆车）

## 注意事项

1. **流量波动**：实际流量可能因检测频率波动
2. **重传开销**：网络不稳定时重传会增加流量
3. **压缩效果**：不同图片压缩效果不同
4. **预留余量**：建议选择比估算值大20-30%的套餐

## 总结

根据当前配置（每天50辆车，每张图片约2MB），**推荐使用3GB/月套餐（约20-30元）**。

通过优化配置（降低图片大小到2MB），可以将流量降至**约1GB/月**，使用**1GB/月套餐（约10-20元）**即可。

建议：
1. 先使用优化配置（2MB限制）运行1-2周
2. 监控实际流量使用情况
3. 根据实际情况调整配置或套餐




