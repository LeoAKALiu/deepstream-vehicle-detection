# 主程序功能差异分析

## 📊 现有功能清单

### ✅ 已实现功能

1. **核心检测与识别**
   - ✅ TensorRT GPU加速检测（YOLOv11，25-30 FPS）
   - ✅ 自定义模型支持（10类车辆：8类工程车辆 + 2类社会车辆）
   - ✅ IoU目标跟踪（唯一ID，防重复计数）
   - ✅ 实时可视化（bbox + 标签 + 中文显示）

2. **工程车辆处理流程**
   - ✅ Orbbec深度相机测距（区域平均，更稳定）
   - ✅ Cassia蓝牙信标扫描（SSE实时流）
   - ✅ 多级信标过滤（白名单、RSSI、距离、时间窗口、置信度）
   - ✅ 车辆类型匹配验证（检测类型 vs 信标绑定类型）
   - ✅ 已备案/未备案判断逻辑

3. **社会车辆处理流程**
   - ✅ HyperLPR车牌识别
   - ✅ ROI裁剪和识别
   - ✅ 车牌号输出

4. **系统集成**
   - ✅ 帧共享机制（用于录制脚本）
   - ✅ 报警记录（内存中，`self.alerts`）
   - ✅ 统计输出（控制台打印）
   - ✅ 错误处理（try-except）

---

## ❓ 缺失或待完善功能

### 1. 数据持久化 ⚠️ 重要

**现状**：
- 报警记录仅保存在内存中（`self.alerts`）
- 程序退出后数据丢失
- 无历史记录查询

**需求**：
- [ ] 报警记录保存到文件（JSON/CSV）
- [ ] 可选：数据库存储（SQLite/MySQL）
- [ ] 时间戳、车辆信息、信标信息完整记录
- [ ] 支持数据查询和统计

**优先级**：🔴 高（现场测试需要记录）

---

### 2. 日志系统 ⚠️ 重要

**现状**：
- 仅控制台输出（print）
- 无日志文件
- 无日志级别管理

**需求**：
- [ ] 日志文件输出（`/tmp/vehicle_detection.log` 或可配置）
- [ ] 日志级别（DEBUG/INFO/WARNING/ERROR）
- [ ] 日志轮转（避免文件过大）
- [ ] 关键事件记录（检测、报警、错误）

**优先级**：🔴 高（调试和问题追踪）

---

### 3. 配置管理

**现状**：
- 部分配置硬编码（IP地址、阈值等）
- 信标白名单有配置文件（`beacon_whitelist.yaml`）
- 其他配置分散在代码中

**需求**：
- [ ] 统一配置文件（YAML/JSON）
- [ ] 可配置项：
  - Cassia IP地址
  - 检测阈值（confidence, IoU）
  - 深度测量参数
  - 信标过滤参数
  - 日志级别和路径
  - 输出路径
- [ ] 命令行参数覆盖配置

**优先级**：🟡 中（提高灵活性）

---

### 4. 统计报告

**现状**：
- 程序退出时打印简单统计
- 无详细报告
- 无导出功能

**需求**：
- [ ] 详细统计报告（JSON/HTML）
- [ ] 按车辆类型统计
- [ ] 按时间段统计
- [ ] 报警汇总
- [ ] 性能指标（FPS、延迟）

**优先级**：🟡 中（现场测试后分析）

---

### 5. 错误恢复机制

**现状**：
- 基本错误处理（try-except）
- 相机/网络错误后可能无法恢复
- 无自动重连机制

**需求**：
- [ ] 相机连接失败自动重试
- [ ] Cassia连接失败自动重连
- [ ] 模型加载失败降级方案
- [ ] 优雅降级（部分功能失效时继续运行）

**优先级**：🟡 中（提高稳定性）

---

### 6. 性能监控

**现状**：
- 简单FPS显示
- 无详细性能指标

**需求**：
- [ ] 实时性能监控（FPS、延迟、GPU使用率）
- [ ] 性能指标记录
- [ ] 性能瓶颈分析
- [ ] 可选的性能报告

**优先级**：🟢 低（优化时有用）

---

### 7. 远程访问/API接口

**现状**：
- 无API接口
- 无远程访问能力

**需求**：
- [ ] RESTful API（查询状态、获取统计）
- [ ] WebSocket实时推送（检测结果、报警）
- [ ] Web管理界面（可选）
- [ ] 远程配置更新

**优先级**：🟢 低（未来扩展）

---

### 8. 数据导出功能

**现状**：
- 无数据导出

**需求**：
- [ ] 导出报警记录（CSV/Excel）
- [ ] 导出统计报告（PDF/HTML）
- [ ] 导出检测结果（JSON）
- [ ] 批量导出功能

**优先级**：🟡 中（数据分析需要）

---

### 9. 测试和验证工具

**现状**：
- 有部分测试脚本
- 无自动化测试

**需求**：
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试脚本
- [ ] 回归测试

**优先级**：🟢 低（开发阶段有用）

---

### 10. 其他改进

**现状**：
- 代码结构良好，但可进一步模块化

**需求**：
- [ ] 更清晰的模块划分
- [ ] 配置验证（启动时检查配置有效性）
- [ ] 健康检查机制
- [ ] 优雅退出（保存数据、清理资源）

**优先级**：🟡 中（代码质量）

---

## 🎯 建议优先级排序

### 现场测试前必须完成（P0）
1. **数据持久化** - 报警记录保存到文件
2. **日志系统** - 日志文件输出

### 现场测试后建议完成（P1）
3. **统计报告** - 详细报告生成
4. **配置管理** - 统一配置文件
5. **数据导出** - 导出功能

### 长期优化（P2）
6. **错误恢复机制** - 自动重连
7. **性能监控** - 详细指标
8. **远程访问/API** - 扩展功能

---

## 📝 讨论要点

1. **数据持久化格式**：JSON vs CSV vs SQLite？
2. **日志级别**：需要哪些级别？DEBUG是否必要？
3. **配置文件格式**：YAML vs JSON vs INI？
4. **统计报告格式**：JSON vs HTML vs PDF？
5. **现场测试需求**：哪些功能是必须的？哪些可以后续添加？

---

**最后更新**: 2024年11月4日

