# 快速参考

## 🆕 新功能：信标白名单过滤

### 配置白名单
```bash
# 编辑配置文件
nano beacon_whitelist.yaml

# 添加信标到白名单（示例）
cameras:
  camera_01:
    beacons:
      - mac: "68:E4:78:XX:XX:XX"
        vehicle_type: "excavator"
        plate_number: "粤BXXXXX"
        active: true
```

### 测试过滤器
```bash
# 测试多级过滤功能
bash 测试信标过滤器.sh
```

### 查看详细文档
```bash
# 查看完整配置指南
cat 信标白名单配置指南.md
```

**功能特点：**
- ✅ 白名单机制 - 只处理已注册信标
- ✅ 多级过滤 - RSSI + 距离 + 时间窗口
- ✅ 置信度评分 - 智能选择最佳匹配
- ✅ 灵活配置 - YAML配置文件

---

## ✅ 已修复的问题

| 问题 | 原因 | 修复 |
|------|------|------|
| 车牌识别异常 | API错误 | `lpr_detector(image)` 直接调用 |
| 深度无法获取 | 单点采样不稳定 | 使用区域中位数 |
| BLE扫描不到 | 标签未开启 | 需检查硬件 |

---

## 🚀 测试命令

### 1. 测试BLE标签（重要！先测试这个）
```bash
cd /home/liubo/Download/deepstream-vehicle-detection
bash 测试BLE信标.sh
```

**预期输出：**
```
✓ 发现信标: MAC=XX:XX:XX:XX, RSSI=-65 dBm
```

**如果无输出：**
- 检查BLE标签LED是否闪烁
- 更换电池
- 靠近路由器测试

---

### 2. 测试完整系统
```bash
cd /home/liubo/Download/deepstream-vehicle-detection
bash 测试自定义模型.sh
```

---

## 📋 测试场景

| 场景 | iPad显示 | BLE标签 | 预期结果 |
|------|---------|---------|---------|
| 1 | 挖掘机图片 | ✅ 贴标签 | 🟠 "工程车辆 (已备案)" |
| 2 | 挖掘机图片 | ❌ 不贴 | 🔴 "⚠ 未备案工程车辆！" |
| 3 | 小汽车图片 | ❌ 不贴 | 🟢 "社会车辆 粤Bxxxxx" |

---

## 🔍 调试输出示例

### 工程车辆（有BLE）
```
🔍 检查工程车辆 Track#1
  📏 相机深度: 2.45 m
  📡 扫描到信标数量: 1
     信标1: MAC=AA:BB:CC:DD, RSSI=-60, 距离≈2.4m
  ✓ 匹配到信标: MAC=AA:BB:CC:DD, 距离差=0.05m
  ✅ 结果: 已备案工程车辆
```

### 工程车辆（无BLE）
```
🔍 检查工程车辆 Track#2
  📏 相机深度: 1.80 m
  📡 扫描到信标数量: 0
  ✗ 未扫描到任何信标
  🚨 结果: 未备案工程车辆！
```

### 社会车辆
```
🚗 检查社会车辆 Track#3
  📐 车辆ROI尺寸: (180, 320, 3)
  🔍 识别结果数量: 1
  ✓ 车牌号: 粤B12345 (置信度: 0.92)
  ✅ 结果: 社会车辆 粤B12345
```

---

## ⚙️ 系统配置

**模型：**
- `models/custom_yolo.engine` (53MB)
- 10个类别（9类工程车 + 1类社会车）

**硬件：**
- Orbbec Gemini 335L（深度测量）
- Cassia路由器 192.168.1.27（BLE扫描）

**性能：**
- FPS: ~15
- 检测延迟: <70ms
- 深度精度: ±2%

---

## 🛠️ 故障排除

### BLE问题
```bash
# 测试BLE
bash 测试BLE信标.sh

# 手动扫描
curl -N 'http://192.168.1.27/gap/nodes?event=1&filter_rssi=-90&active=1'
```

### 深度问题
- iPad角度调整（避免正面反光）
- 距离调整（1-3米最佳）
- 如果仍无法获取，系统会自动跳过深度匹配

### 车牌问题
- 使用清晰的车牌图片
- 车牌占比>5%
- 避免倾斜角度

---

## 📞 关键文件

| 文件 | 用途 |
|------|------|
| `beacon_whitelist.yaml` | **信标白名单配置** ⭐ |
| `信标白名单配置指南.md` | **白名单配置文档** ⭐ |
| `测试信标过滤器.sh` | 测试过滤器功能 |
| `测试BLE信标.sh` | BLE硬件测试 |
| `测试自定义模型.sh` | 完整系统测试 |
| `调试指南.md` | 详细调试步骤 |
| `API参考文档.md` | API正确用法 |


